<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Odds Comparator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>
    <script type="text/babel">
const { useState } = React;
const API_URL = 'https://nba-betting-1.onrender.com';

function App() {
    const [opps, setOpps] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [statType, setStatType] = useState('points');
    const [minEdge, setMinEdge] = useState(5);
    const [manual, setManual] = useState({});
    const [apiUsage, setApiUsage] = useState(null);
    const [status, setStatus] = useState('');

    const scan = async () => {
        setLoading(true);
        setError(null);
        setStatus('‚è≥ R√©veil du serveur (30-60s)...');
        try {
            await fetch(`${API_URL}/api/health`).catch(() => {});
            setStatus('üîç Scan en cours...');
            
            const res = await fetch(`${API_URL}/api/daily-opportunities?stat_type=${statType}&min_edge=${minEdge}`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            if (data.status === 'SUCCESS') {
                setOpps(data.opportunities || []);
                const init = {};
                data.opportunities?.forEach((o, i) => {
                    init[i] = { line: o.line_analysis.bookmaker_line, odds: o.line_analysis.odds };
                });
                setManual(init);
                setStatus(`‚úÖ ${data.opportunities?.length || 0} opportunit√©s`);
            } else {
                setError(data.message || 'Erreur');
            }
            try {
                const usage = await fetch(`${API_URL}/api/odds/usage`);
                setApiUsage(await usage.json());
            } catch(e) {}
        } catch (e) {
            setError(e.message);
        }
        setLoading(false);
    };

    const update = (i, field, val) => {
        setManual(p => ({ ...p, [i]: { ...p[i], [field]: parseFloat(val) || 0 } }));
    };

    const impliedProb = (odds) => odds > 0 ? 100/(odds+100) : Math.abs(odds)/(Math.abs(odds)+100);
    
    const calcEdge = (o, m) => {
        const prob = o.line_analysis.recommendation === 'OVER' ? o.line_analysis.over_probability : o.line_analysis.under_probability;
        return prob - impliedProb(m.odds) * 100;
    };

    const calcEV = (o, m) => {
        const prob = (o.line_analysis.recommendation === 'OVER' ? o.line_analysis.over_probability : o.line_analysis.under_probability) / 100;
        const payout = m.odds > 0 ? m.odds/100 : 100/Math.abs(m.odds);
        return (prob * payout - (1 - prob)) * 100;
    };

    const edgeColor = (e) => e >= 10 ? '#22c55e' : e >= 5 ? '#84cc16' : e >= 0 ? '#eab308' : '#ef4444';

    return (
        <div className="min-h-screen p-4">
            <div className="max-w-2xl mx-auto">
                <h1 className="text-2xl font-bold text-center mb-2">üèÄ NBA Odds Comparator</h1>
                <p className="text-slate-400 text-center text-sm mb-4">Compare API vs BetOnline</p>

                {apiUsage && (
                    <p className="text-center text-xs text-slate-500 mb-2">
                        API: {apiUsage.used}/{parseInt(apiUsage.used||0)+parseInt(apiUsage.remaining||0)} calls
                    </p>
                )}
                
                {status && !error && (
                    <p className="text-center text-sm text-blue-400 mb-4">{status}</p>
                )}

                <div className="bg-slate-800 rounded-lg p-4 mb-4">
                    <div className="flex flex-wrap gap-3 items-end justify-center">
                        <div>
                            <label className="block text-xs text-slate-400 mb-1">Stat</label>
                            <select value={statType} onChange={e => setStatType(e.target.value)}
                                className="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-sm">
                                <option value="points">üìä Points</option>
                                <option value="assists">üéØ Assists</option>
                                <option value="rebounds">üèÄ Rebounds</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs text-slate-400 mb-1">Edge min</label>
                            <input type="number" value={minEdge} onChange={e => setMinEdge(e.target.value)}
                                className="bg-slate-700 border border-slate-600 rounded px-2 py-2 w-16 text-sm"/>
                        </div>
                        <button onClick={scan} disabled={loading}
                            className="bg-gradient-to-r from-purple-600 to-blue-600 px-5 py-2 rounded-lg font-semibold disabled:opacity-50">
                            {loading ? '‚è≥...' : 'üîç Scanner'}
                        </button>
                    </div>
                </div>

                {error && (
                    <div className="bg-red-900/50 border border-red-500 rounded-lg p-3 mb-4 text-sm">
                        ‚ùå {error}
                    </div>
                )}

                <div className="space-y-3">
                    {opps.map((o, i) => {
                        const m = manual[i] || { line: o.line_analysis.bookmaker_line, odds: o.line_analysis.odds };
                        const edge = calcEdge(o, m);
                        const ev = calcEV(o, m);
                        const lineDiff = m.line - o.line_analysis.bookmaker_line;
                        const isGood = edge >= 5 && ev > 0;
                        
                        return (
                            <div key={i} className={`bg-slate-800 rounded-lg p-3 border ${isGood ? 'border-green-500' : 'border-slate-700'}`}>
                                <div className="flex justify-between items-center mb-2">
                                    <div>
                                        <span className="font-bold">{o.player}</span>
                                        <span className="text-slate-400 text-sm ml-2">{o.team}</span>
                                    </div>
                                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${o.line_analysis.recommendation === 'OVER' ? 'bg-green-600' : 'bg-red-600'}`}>
                                        {o.line_analysis.recommendation}
                                    </span>
                                </div>

                                <div className="grid grid-cols-2 gap-2 mb-3 text-sm">
                                    <div className="bg-slate-700/50 rounded p-2">
                                        <p className="text-xs text-slate-400">üì° {o.line_analysis.bookmaker}</p>
                                        <p>Line: <span className="text-blue-400 font-mono">{o.line_analysis.bookmaker_line}</span></p>
                                        <p>Odds: <span className="text-blue-400 font-mono">{o.line_analysis.odds > 0 ? '+' : ''}{o.line_analysis.odds}</span></p>
                                    </div>
                                    <div className="bg-slate-700/50 rounded p-2 border border-yellow-500/50">
                                        <p className="text-xs text-yellow-400">‚úèÔ∏è BetOnline</p>
                                        <div className="flex items-center gap-1">
                                            <span>Line:</span>
                                            <input type="number" step="0.5" value={m.line}
                                                onChange={e => update(i, 'line', e.target.value)}
                                                className="bg-slate-600 border border-yellow-500/30 rounded px-1 py-0.5 w-16 text-yellow-400 font-mono text-sm"/>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <span>Odds:</span>
                                            <input type="number" value={m.odds}
                                                onChange={e => update(i, 'odds', e.target.value)}
                                                className="bg-slate-600 border border-yellow-500/30 rounded px-1 py-0.5 w-16 text-yellow-400 font-mono text-sm"/>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-4 gap-1 text-center text-xs">
                                    <div className="bg-slate-700 rounded p-1.5">
                                        <p className="text-slate-400">Prob</p>
                                        <p className="font-bold text-green-400">
                                            {o.line_analysis.recommendation === 'OVER' ? o.line_analysis.over_probability : o.line_analysis.under_probability}%
                                        </p>
                                    </div>
                                    <div className="bg-slate-700 rounded p-1.5">
                                        <p className="text-slate-400">Line Œî</p>
                                        <p className={`font-bold ${lineDiff === 0 ? 'text-slate-300' : lineDiff > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                            {lineDiff > 0 ? '+' : ''}{lineDiff.toFixed(1)}
                                        </p>
                                    </div>
                                    <div className="bg-slate-700 rounded p-1.5">
                                        <p className="text-slate-400">Edge</p>
                                        <p className="font-bold" style={{color: edgeColor(edge)}}>{edge.toFixed(1)}%</p>
                                    </div>
                                    <div className="bg-slate-700 rounded p-1.5">
                                        <p className="text-slate-400">EV</p>
                                        <p className={`font-bold ${ev >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {ev >= 0 ? '+' : ''}{ev.toFixed(1)}%
                                        </p>
                                    </div>
                                </div>

                                <div className="mt-2 text-xs text-slate-500 flex justify-between">
                                    <span>L5: {o.deep_stats.avg_last_5}</span>
                                    <span>Mean: {o.deep_stats.clean_mean}</span>
                                    <span>Cons: {o.deep_stats.consistency}%</span>
                                </div>

                                {isGood && (
                                    <div className="mt-2 bg-green-900/30 border border-green-500 rounded p-1.5 text-center text-green-400 text-sm font-semibold">
                                        ‚úÖ Bet valid√©!
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>

                {!loading && opps.length === 0 && !error && (
                    <div className="text-center text-slate-500 py-12">
                        <p className="text-4xl mb-2">üèÄ</p>
                        <p>Clique Scanner pour trouver des opportunit√©s</p>
                    </div>
                )}
            </div>
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>