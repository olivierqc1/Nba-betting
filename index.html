<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Betting Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>
    <script type="text/babel">
const { useState } = React;
const API_URL = 'https://nba-betting-1.onrender.com';

function App() {
    const [opps, setOpps] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [statType, setStatType] = useState('points');
    const [minEdge, setMinEdge] = useState(5);
    const [manual, setManual] = useState({});
    const [status, setStatus] = useState('');
    const [expanded, setExpanded] = useState({});

    const scan = async () => {
        setLoading(true);
        setError(null);
        setStatus('‚è≥ R√©veil serveur (30-60s)...');
        try {
            await fetch(`${API_URL}/api/health`).catch(() => {});
            setStatus('üîç Analyse en cours...');
            const res = await fetch(`${API_URL}/api/daily-opportunities?stat_type=${statType}&min_edge=${minEdge}`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            if (data.status === 'SUCCESS') {
                setOpps(data.opportunities || []);
                const init = {};
                data.opportunities?.forEach((o, i) => { init[i] = { line: '', odds: '' }; });
                setManual(init);
                setStatus(`‚úÖ ${data.opportunities?.length || 0} opportunit√©s`);
            } else {
                setError(data.message || 'Erreur');
            }
        } catch (e) {
            setError(e.message);
        }
        setLoading(false);
    };

    const update = (i, field, val) => {
        setManual(p => ({ ...p, [i]: { ...p[i], [field]: val } }));
    };

    const toggle = (i) => {
        setExpanded(p => ({ ...p, [i]: !p[i] }));
    };

    // Calculate reliability score (0-100)
    const getReliability = (o) => {
        const cons = o.deep_stats.consistency || 0;
        const std = o.deep_stats.std || 999;
        const mean = o.deep_stats.clean_mean || 1;
        const cv = (std / mean) * 100; // Coefficient of variation
        
        // Good: cons > 60, cv < 30
        // Bad: cons < 30, cv > 50
        let score = cons;
        if (cv > 50) score -= 20;
        if (cv < 30) score += 10;
        if (o.deep_stats.avg_last_5 === 0) score -= 30; // Data issue
        
        return Math.max(0, Math.min(100, score));
    };

    // Adjusted probability = historical prob weighted by reliability
    const getAdjustedProb = (o) => {
        const reliability = getReliability(o);
        const rawProb = o.line_analysis.recommendation === 'OVER' 
            ? o.line_analysis.over_probability 
            : o.line_analysis.under_probability;
        
        // If reliability is low, move probability toward 50%
        const adjusted = 50 + (rawProb - 50) * (reliability / 100);
        return adjusted;
    };

    const impliedProb = (odds) => {
        const o = parseFloat(odds);
        if (isNaN(o)) return 50;
        return o > 0 ? 100/(o+100)*100 : Math.abs(o)/(Math.abs(o)+100)*100;
    };

    const calcEdge = (o, m) => {
        if (!m.odds || m.odds === '') return null;
        const prob = getAdjustedProb(o);
        return prob - impliedProb(m.odds);
    };

    const calcEV = (o, m) => {
        if (!m.odds || m.odds === '') return null;
        const prob = getAdjustedProb(o) / 100;
        const odds = parseFloat(m.odds);
        const payout = odds > 0 ? odds/100 : 100/Math.abs(odds);
        return (prob * payout - (1 - prob)) * 100;
    };

    // Filter TOP PICKS: high reliability + edge
    const topPicks = opps.filter(o => {
        const reliability = getReliability(o);
        return reliability >= 40 && 
               o.line_analysis.edge >= 8 && 
               o.deep_stats.avg_last_5 > 0 &&
               o.deep_stats.consistency > 35;
    }).sort((a, b) => getReliability(b) - getReliability(a)).slice(0, 5);

    return (
        <div className="min-h-screen p-3 pb-20">
            <div className="max-w-lg mx-auto">
                <h1 className="text-xl font-bold text-center mb-3">üèÄ NBA Analyzer v9</h1>

                {/* Controls */}
                <div className="bg-slate-800 rounded-lg p-3 mb-3">
                    <div className="flex gap-2 items-center justify-center flex-wrap">
                        <select value={statType} onChange={e => setStatType(e.target.value)}
                            className="bg-slate-700 border border-slate-600 rounded px-2 py-2 text-sm">
                            <option value="points">Points</option>
                            <option value="assists">Assists</option>
                            <option value="rebounds">Rebounds</option>
                        </select>
                        <input type="number" value={minEdge} onChange={e => setMinEdge(e.target.value)}
                            className="bg-slate-700 border border-slate-600 rounded px-2 py-2 w-14 text-sm" placeholder="Edge"/>
                        <button onClick={scan} disabled={loading}
                            className="bg-gradient-to-r from-purple-600 to-blue-600 px-4 py-2 rounded-lg font-bold disabled:opacity-50">
                            {loading ? '‚è≥' : 'üîç Scan'}
                        </button>
                    </div>
                    {status && <p className="text-center text-xs text-blue-400 mt-2">{status}</p>}
                </div>

                {error && (
                    <div className="bg-red-900/50 border border-red-500 rounded p-2 mb-3 text-sm">‚ùå {error}</div>
                )}

                {/* ‚ö° TOP PICKS SUMMARY */}
                {topPicks.length > 0 && (
                    <div className="bg-gradient-to-br from-green-900/70 to-emerald-900/70 border-2 border-green-500 rounded-xl p-3 mb-4">
                        <h2 className="text-lg font-bold text-green-400 mb-2">‚ö° Top {topPicks.length} Picks Fiables</h2>
                        <div className="space-y-2">
                            {topPicks.map((o, i) => {
                                const reliability = getReliability(o);
                                const adjProb = getAdjustedProb(o);
                                return (
                                    <div key={i} className="flex items-center justify-between bg-slate-800/80 rounded-lg px-3 py-2">
                                        <div className="flex items-center gap-2">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${o.line_analysis.recommendation === 'OVER' ? 'bg-green-600' : 'bg-red-600'}`}>
                                                {o.line_analysis.recommendation}
                                            </span>
                                            <div>
                                                <p className="font-bold text-sm">{o.player}</p>
                                                <p className="text-xs text-slate-400">{o.line_analysis.bookmaker_line} pts</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-green-400 font-bold">{adjProb.toFixed(0)}%</p>
                                            <p className="text-xs text-slate-400">Fiab: {reliability}%</p>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <p className="text-xs text-slate-400 mt-2 text-center">
                            Prob ajust√©e = historique √ó fiabilit√©
                        </p>
                    </div>
                )}

                {topPicks.length === 0 && opps.length > 0 && (
                    <div className="bg-orange-900/30 border border-orange-500 rounded-lg p-3 mb-4 text-center">
                        <p className="text-orange-400 text-sm">‚ö†Ô∏è Aucun pick fiable trouv√©</p>
                        <p className="text-xs text-slate-400">Donn√©es trop volatiles ou edge insuffisant</p>
                    </div>
                )}

                {/* ALL OPPORTUNITIES */}
                <div className="space-y-2">
                    {opps.map((o, i) => {
                        const m = manual[i] || { line: '', odds: '' };
                        const hasManual = m.line !== '' && m.odds !== '';
                        const edge = calcEdge(o, m);
                        const ev = calcEV(o, m);
                        const reliability = getReliability(o);
                        const adjProb = getAdjustedProb(o);
                        const rawProb = o.line_analysis.recommendation === 'OVER' 
                            ? o.line_analysis.over_probability 
                            : o.line_analysis.under_probability;
                        const isExpanded = expanded[i];
                        const isReliable = reliability >= 40;
                        const lineDiff = hasManual ? parseFloat(m.line) - o.line_analysis.bookmaker_line : null;
                        
                        return (
                            <div key={i} className={`bg-slate-800 rounded-lg p-3 border ${
                                !isReliable ? 'border-orange-500/50 opacity-70' : 
                                hasManual && edge >= 5 ? 'border-green-500' : 'border-slate-700'
                            }`}>
                                {/* Header */}
                                <div className="flex justify-between items-start">
                                    <div className="flex items-center gap-2">
                                        <span className={`px-2 py-1 rounded text-xs font-bold ${o.line_analysis.recommendation === 'OVER' ? 'bg-green-600' : 'bg-red-600'}`}>
                                            {o.line_analysis.recommendation}
                                        </span>
                                        <div>
                                            <p className="font-bold">{o.player}</p>
                                            <p className="text-xs text-slate-400">{o.team} ‚Ä¢ Line: {o.line_analysis.bookmaker_line}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className={`font-bold ${isReliable ? 'text-green-400' : 'text-orange-400'}`}>
                                            {adjProb.toFixed(0)}%
                                        </p>
                                        <p className="text-xs text-slate-500">
                                            Fiab: <span className={reliability >= 40 ? 'text-green-400' : 'text-orange-400'}>{reliability}%</span>
                                        </p>
                                    </div>
                                </div>

                                {/* Warning if unreliable */}
                                {!isReliable && (
                                    <p className="text-xs text-orange-400 mt-1">‚ö†Ô∏è Donn√©es trop volatiles - prob ajust√©e vers 50%</p>
                                )}

                                {/* Quick stats row */}
                                <div className="flex justify-between text-xs mt-2 bg-slate-700/30 rounded p-2">
                                    <span>L5: <span className="text-white font-medium">{o.deep_stats.avg_last_5}</span></span>
                                    <span>Mean: <span className="text-white font-medium">{o.deep_stats.clean_mean}</span></span>
                                    <span>œÉ: <span className="text-cyan-400">{o.deep_stats.std}</span></span>
                                    <span>Cons: <span className={o.deep_stats.consistency > 40 ? 'text-green-400' : 'text-orange-400'}>{o.deep_stats.consistency}%</span></span>
                                </div>

                                {/* Expand button */}
                                <button onClick={() => toggle(i)} className="w-full text-xs text-slate-500 mt-2 hover:text-white">
                                    {isExpanded ? '‚ñ≤ Fermer' : '‚ñº BetOnline + D√©tails'}
                                </button>

                                {/* Expanded section */}
                                {isExpanded && (
                                    <div className="mt-2 pt-2 border-t border-slate-700">
                                        {/* Prob explanation */}
                                        <div className="bg-slate-700/30 rounded p-2 mb-2 text-xs">
                                            <p>Prob brute: {rawProb}% ‚Üí Ajust√©e: {adjProb.toFixed(0)}%</p>
                                            <p className="text-slate-400">Ajustement bas√© sur fiabilit√© ({reliability}%)</p>
                                        </div>

                                        {/* BetOnline inputs */}
                                        <div className="grid grid-cols-2 gap-2 mb-2">
                                            <div className="bg-slate-700/50 rounded p-2 text-sm">
                                                <p className="text-xs text-slate-400 mb-1">{o.line_analysis.bookmaker}</p>
                                                <p>Line: <span className="text-blue-400">{o.line_analysis.bookmaker_line}</span></p>
                                                <p>Odds: <span className="text-blue-400">{o.line_analysis.odds}</span></p>
                                            </div>
                                            <div className="bg-slate-700/50 rounded p-2 text-sm border border-yellow-500/30">
                                                <p className="text-xs text-yellow-400 mb-1">BetOnline</p>
                                                <div className="flex items-center gap-1 mb-1">
                                                    <span className="text-xs">Line:</span>
                                                    <input type="number" step="0.5" value={m.line} placeholder="‚Äî"
                                                        onChange={e => update(i, 'line', e.target.value)}
                                                        className="bg-slate-600 border border-yellow-500/30 rounded px-1 py-0.5 w-14 text-yellow-400 text-sm"/>
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <span className="text-xs">Odds:</span>
                                                    <input type="number" value={m.odds} placeholder="‚Äî"
                                                        onChange={e => update(i, 'odds', e.target.value)}
                                                        className="bg-slate-600 border border-yellow-500/30 rounded px-1 py-0.5 w-14 text-yellow-400 text-sm"/>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Calculated values */}
                                        {hasManual && (
                                            <div className="grid grid-cols-3 gap-1 text-center text-xs mb-2">
                                                <div className="bg-slate-700 rounded p-1.5">
                                                    <p className="text-slate-400">Line Œî</p>
                                                    <p className={`font-bold ${lineDiff === 0 ? 'text-white' : lineDiff > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                        {lineDiff > 0 ? '+' : ''}{lineDiff.toFixed(1)}
                                                    </p>
                                                </div>
                                                <div className="bg-slate-700 rounded p-1.5">
                                                    <p className="text-slate-400">Edge</p>
                                                    <p className={`font-bold ${edge >= 5 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {edge.toFixed(1)}%
                                                    </p>
                                                </div>
                                                <div className="bg-slate-700 rounded p-1.5">
                                                    <p className="text-slate-400">EV</p>
                                                    <p className={`font-bold ${ev >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                        {ev >= 0 ? '+' : ''}{ev.toFixed(1)}%
                                                    </p>
                                                </div>
                                            </div>
                                        )}

                                        {/* More stats */}
                                        <div className="grid grid-cols-3 gap-1 text-center text-xs">
                                            <div className="bg-slate-700/30 rounded p-1">
                                                <p className="text-slate-500">R¬≤</p>
                                                <p className={o.deep_stats.r_squared >= 0.1 ? 'text-green-400' : 'text-orange-400'}>
                                                    {o.deep_stats.r_squared}
                                                </p>
                                            </div>
                                            <div className="bg-slate-700/30 rounded p-1">
                                                <p className="text-slate-500">Games</p>
                                                <p>{o.deep_stats.games_analyzed}</p>
                                            </div>
                                            <div className="bg-slate-700/30 rounded p-1">
                                                <p className="text-slate-500">Chi¬≤</p>
                                                <p>{o.deep_stats.chi_ok ? '‚úÖ' : '‚ùå'}</p>
                                            </div>
                                        </div>

                                        {hasManual && edge >= 5 && ev > 0 && isReliable && (
                                            <div className="mt-2 bg-green-900/50 border border-green-500 rounded p-2 text-center">
                                                <p className="text-green-400 font-bold">‚úÖ BET VALID√â</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>

                {!loading && opps.length === 0 && !error && (
                    <div className="text-center text-slate-500 py-12">
                        <p className="text-4xl mb-2">üèÄ</p>
                        <p>Clique Scan pour analyser</p>
                    </div>
                